<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RepRise.app - Track Your Progress</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
</head>
<body class="bg-base-200 p-6">
    <div class="container mx-auto max-w-lg bg-white p-6 rounded-lg shadow-lg">
        <h1 class="text-2xl font-bold text-center mb-4">Progress Tracker</h1>
        <div class="flex flex-col gap-2">
            <label for="exerciseType" class="text-lg">Select Exercise:</label>
            <select id="exerciseType" class="select select-bordered w-full">
                <option value="pushups">Pushups</option>
                <option value="pullups">Pullups</option>
                <option value="dips">Dips</option>
            </select>
            <input type="number" id="entryInput" placeholder="Enter reps" min="1" class="input input-bordered w-full" />
            <button id="logButton" class="btn btn-primary w-full">Log Progress</button>
            
            <div class="mt-4 pt-4">
                <select id="dateRange" class="select select-bordered w-full mt-2">
                    <option value="last24" selected>Last 24 hours</option>
                    <option value="last7">Last 7 days</option>
                    <option value="last30">Last 30 days</option>
                    <option value="all">All</option>
                </select>
            </div>
            
            <div class="collapse collapse-arrow mt-2 border border-gray-300 rounded-lg">
                <input type="checkbox" id="toggleNewExercise" class="hidden" />
                <label for="toggleNewExercise" class="collapse-title text-lg font-medium cursor-pointer text-center">Missing exercise? Click to add</label>
                <div class="collapse-content flex flex-col gap-2 p-2">
                    <input type="text" id="newExercise" placeholder="New exercise name" class="input input-bordered w-full" />
                    <button id="addExerciseButton" class="btn btn-secondary w-full">Add Exercise</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto mt-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="cardsContainer"></div>

    <div class="container mx-auto mt-6 bg-white p-6 rounded-lg shadow-lg" id="insightsContainer">
        <h2 class="text-xl font-bold text-center mb-4">Your Progress Insights</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="insightsGrid"></div>
    </div>

    <div class="container mx-auto mt-6 text-center">
        <button id="exportButton" class="btn btn-secondary btn-lg">Export Progress Data</button>
    </div>

    <script src="DataManager.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const dataManager = new DataManager();
            const logButton = document.getElementById("logButton");
            const addExerciseButton = document.getElementById("addExerciseButton");
            const entryInput = document.getElementById("entryInput");
            const exerciseType = document.getElementById("exerciseType");
            const newExerciseInput = document.getElementById("newExercise");
            const cardsContainer = document.getElementById("cardsContainer");
            const exportButton = document.getElementById("exportButton");
            const dateRange = document.getElementById("dateRange");
            const insightsContainer = document.getElementById("insightsContainer");
            const insightsGrid = document.getElementById("insightsGrid");

            function updateCards() {
                cardsContainer.innerHTML = "";
                const data = dataManager.getEntries();
                const selectedRange = dateRange.value;
                
                let hasDataToShow = false;

                Object.keys(data).forEach(exercise => {
                    let entries = data[exercise] || [];
                    if (entries.length === 0) return;
                    
                    // Filter entries based on date range
                    entries = filterEntriesByDateRange(entries, selectedRange);
                    if (entries.length === 0) return;
                    
                    hasDataToShow = true;
                    
                    const card = document.createElement("div");
                    card.className = "card bg-white shadow-md p-4 rounded-lg";
                    card.innerHTML = `
                        <h3 class="text-lg font-semibold">${exercise.charAt(0).toUpperCase() + exercise.slice(1)}</h3>
                        <h2 class="text-2xl text-primary font-bold">Max: ${Math.max(...entries.map(e => e.value))} reps</h2>
                        <h3 class="text-lg text-gray-600">Total: ${entries.reduce((sum, e) => sum + e.value, 0)} reps</h3>
                        <p class="text-gray-500">${new Date(entries[entries.length - 1].date).toLocaleString()}</p>
                        <canvas id="chart-${exercise}" class="mt-4"></canvas>
                    `;
                    cardsContainer.appendChild(card);

                    setTimeout(() => updateChart(exercise, entries), 100);
                });
                
                // Display motivational message if no data to show
                if (!hasDataToShow) {
                    const motivationCard = document.createElement("div");
                    motivationCard.className = "card bg-white shadow-md p-8 rounded-lg text-center mx-auto max-w-md";
                    
                    const messages = [
                        "Time to create some progress! Start logging your first exercise.",
                        "Every rep counts! Let's get started and track your journey.",
                        "The best time to start was yesterday. The second best time is now!",
                        "Progress happens one rep at a time. Ready to begin?",
                        "Success is built on daily habits. Start tracking yours today!"
                    ];
                    
                    const randomMessage = messages[Math.floor(Math.random() * messages.length)];
                    
                    motivationCard.innerHTML = `
                        <h2 class="text-2xl text-primary font-bold mb-4">No data for this time period</h2>
                        <p class="text-lg">${randomMessage}</p>
                        <button id="startLoggingBtn" class="btn btn-primary mt-4">Start Logging</button>
                    `;
                    cardsContainer.appendChild(motivationCard);
                    
                    // Scroll to input and focus on it when "Start Logging" is clicked
                    document.getElementById("startLoggingBtn").addEventListener("click", () => {
                        document.querySelector(".container.max-w-lg").scrollIntoView({ behavior: "smooth" });
                        entryInput.focus();
                    });
                    
                    // Hide insights if no data to show
                    insightsContainer.style.display = "none";
                } else {
                    // Generate insights
                    generateInsights();
                }
            }

            function updateChart(exercise, entries) {
                const canvas = document.getElementById(`chart-${exercise}`);
                if (!canvas) return;
                const ctx = canvas.getContext("2d");
                
                canvas.height = 100;

                const labels = entries.map(entry => new Date(entry.date).toLocaleDateString());
                const values = entries.map(entry => entry.value);

                new Chart(ctx, {
                        type: "line",
                        data: {
                            labels: labels,
                            datasets: [{
                                label: "Progress",
                                data: values,
                                borderColor: "#3b82f6",
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4, // Makes the line smooth
                                backgroundColor: "rgba(59, 130, 246, 0.1)" // Light fill under the curve
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            scales: {
                                x: { display: false },
                                y: { beginAtZero: true }
                            },
                            elements: {
                                point: { radius: 2 }
                            },
                            plugins: {
                                legend: { display: false }
                            }
                        },
                    type: "line",
                    data: {
                        labels: labels,
                        datasets: [{
                            label: "Progress",
                            data: values,
                            borderColor: "#3b82f6",
                            borderWidth: 2,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            x: { display: false },
                            y: { beginAtZero: true }
                        },
                        elements: {
                            point: { radius: 2 }
                        },
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            }

            function filterEntriesByDateRange(entries, range) {
                const now = new Date();
                
                const last24Hours = new Date(now);
                last24Hours.setHours(now.getHours() - 24); // 24 hours ago from now
                
                const last7Days = new Date(now);
                last7Days.setDate(now.getDate() - 6); // 7 days ago
                
                const last30Days = new Date(now);
                last30Days.setDate(now.getDate() - 29); // 30 days ago
                
                switch (range) {
                    case "last24":
                        return entries.filter(entry => new Date(entry.date) >= last24Hours);
                    case "last7":
                        return entries.filter(entry => new Date(entry.date) >= last7Days);
                    case "last30":
                        return entries.filter(entry => new Date(entry.date) >= last30Days);
                    case "all":
                    default:
                        return entries;
                }
            }

            function generateInsights() {
                insightsGrid.innerHTML = "";
                const data = dataManager.getEntries();
                const selectedRange = dateRange.value;
                
                if (Object.keys(data).length === 0) {
                    insightsContainer.style.display = "none";
                    return;
                }
                
                // Filter data based on selected range
                const filteredData = {};
                let hasData = false;
                
                Object.keys(data).forEach(exercise => {
                    const entries = data[exercise] || [];
                    const filteredEntries = filterEntriesByDateRange(entries, selectedRange);
                    if (filteredEntries.length > 0) {
                        filteredData[exercise] = filteredEntries;
                        hasData = true;
                    }
                });
                
                if (!hasData) {
                    insightsContainer.style.display = "none";
                    return;
                }
                
                insightsContainer.style.display = "block";
                
                // Generate various insights
                generatePersonalRecordInsights(filteredData);
                generateConsistencyInsights(filteredData);
                generateVolumeInsights(filteredData);
                generateTimeOfDayInsights(filteredData);
                generateProgressTrendInsights(filteredData);
            }
            
            function generatePersonalRecordInsights(data) {
                Object.keys(data).forEach(exercise => {
                    const entries = data[exercise];
                    if (entries.length === 0) return;
                    
                    // Find max value
                    const maxValue = Math.max(...entries.map(e => e.value));
                    const maxEntry = entries.find(e => e.value === maxValue);
                    const maxDate = new Date(maxEntry.date);
                    
                    // Check if max is recent (in the last 7 days)
                    const isRecent = (new Date() - maxDate) / (1000 * 60 * 60 * 24) < 7;
                    
                    // Create insight card
                    const insightCard = document.createElement("div");
                    insightCard.className = "card bg-base-100 shadow-sm p-4 border-l-4 border-primary";
                    
                    let title = `<span class="text-primary font-bold">${exercise.charAt(0).toUpperCase() + exercise.slice(1)}</span> Personal Record`;
                    let description = `Your best performance: <span class="text-2xl font-bold">${maxValue} reps</span>`;
                    
                    if (isRecent) {
                        description += `<br><span class="text-success font-medium">ðŸŽ‰ New recent record!</span>`;
                    }
                    
                    description += `<br><span class="text-sm text-gray-500">Achieved on ${maxDate.toLocaleDateString()}</span>`;
                    
                    insightCard.innerHTML = `
                        <h3 class="text-lg font-semibold">${title}</h3>
                        <p class="mt-2">${description}</p>
                    `;
                    
                    insightsGrid.appendChild(insightCard);
                });
            }
            
            function generateConsistencyInsights(data) {
                // Calculate frequency of workouts
                const allDates = {};
                
                Object.keys(data).forEach(exercise => {
                    const entries = data[exercise];
                    
                    // Count days with this exercise
                    const exerciseDays = new Set();
                    entries.forEach(entry => {
                        const dateStr = new Date(entry.date).toLocaleDateString();
                        exerciseDays.add(dateStr);
                        
                        if (!allDates[dateStr]) {
                            allDates[dateStr] = new Set();
                        }
                        allDates[dateStr].add(exercise);
                    });
                    
                    if (exerciseDays.size <= 1) return;
                    
                    const insightCard = document.createElement("div");
                    insightCard.className = "card bg-base-100 shadow-sm p-4 border-l-4 border-accent";
                    
                    const title = `<span class="text-accent font-bold">${exercise.charAt(0).toUpperCase() + exercise.slice(1)}</span> Consistency`;
                    const description = `You've trained <span class="text-xl font-bold">${exerciseDays.size} days</span> in this period`;
                    
                    insightCard.innerHTML = `
                        <h3 class="text-lg font-semibold">${title}</h3>
                        <p class="mt-2">${description}</p>
                    `;
                    
                    insightsGrid.appendChild(insightCard);
                });
                
                // Overall activity insight
                if (Object.keys(allDates).length > 1) {
                    const mostActiveDate = Object.keys(allDates).reduce((a, b) => 
                        allDates[a].size > allDates[b].size ? a : b
                    );
                    
                    const insightCard = document.createElement("div");
                    insightCard.className = "card bg-base-100 shadow-sm p-4 border-l-4 border-secondary";
                    
                    const title = "Most Active Day";
                    const exercises = Array.from(allDates[mostActiveDate]).map(e => 
                        e.charAt(0).toUpperCase() + e.slice(1)
                    ).join(", ");
                    
                    insightCard.innerHTML = `
                        <h3 class="text-lg font-semibold">${title}</h3>
                        <p class="mt-2">On ${mostActiveDate}, you trained <span class="text-xl font-bold">${allDates[mostActiveDate].size} exercises</span>: ${exercises}</p>
                    `;
                    
                    insightsGrid.appendChild(insightCard);
                }
            }
            
            function generateVolumeInsights(data) {
                Object.keys(data).forEach(exercise => {
                    const entries = data[exercise];
                    if (entries.length < 2) return;
                    
                    const totalVolume = entries.reduce((sum, entry) => sum + entry.value, 0);
                    const avgReps = Math.round(totalVolume / entries.length * 10) / 10;
                    
                    const insightCard = document.createElement("div");
                    insightCard.className = "card bg-base-100 shadow-sm p-4 border-l-4 border-info";
                    
                    const title = `<span class="text-info font-bold">${exercise.charAt(0).toUpperCase() + exercise.slice(1)}</span> Volume`;
                    const description = `
                        Total: <span class="text-xl font-bold">${totalVolume} reps</span><br>
                        Average: <span class="font-medium">${avgReps} reps</span> per session<br>
                        Sessions: <span class="font-medium">${entries.length}</span>
                    `;
                    
                    insightCard.innerHTML = `
                        <h3 class="text-lg font-semibold">${title}</h3>
                        <p class="mt-2">${description}</p>
                    `;
                    
                    insightsGrid.appendChild(insightCard);
                });
            }
            
            function generateTimeOfDayInsights(data) {
                Object.keys(data).forEach(exercise => {
                    const entries = data[exercise];
                    if (entries.length < 3) return;
                    
                    // Group by time of day
                    const morning = entries.filter(e => {
                        const hour = new Date(e.date).getHours();
                        return hour >= 5 && hour < 12;
                    });
                    
                    const afternoon = entries.filter(e => {
                        const hour = new Date(e.date).getHours();
                        return hour >= 12 && hour < 18;
                    });
                    
                    const evening = entries.filter(e => {
                        const hour = new Date(e.date).getHours();
                        return hour >= 18 || hour < 5;
                    });
                    
                    if (morning.length >= 2 && evening.length >= 2) {
                        const morningAvg = morning.reduce((sum, e) => sum + e.value, 0) / morning.length;
                        const eveningAvg = evening.reduce((sum, e) => sum + e.value, 0) / evening.length;
                        
                        const difference = Math.round(Math.abs(morningAvg - eveningAvg) / Math.min(morningAvg, eveningAvg) * 100);
                        
                        if (difference >= 10) {
                            const betterTime = morningAvg > eveningAvg ? "morning" : "evening";
                            
                            const insightCard = document.createElement("div");
                            insightCard.className = "card bg-base-100 shadow-sm p-4 border-l-4 border-warning";
                            
                            const title = `Best Time for ${exercise.charAt(0).toUpperCase() + exercise.slice(1)}`;
                            const description = `You perform <span class="text-xl font-bold">${difference}%</span> better in the ${betterTime}`;
                            
                            insightCard.innerHTML = `
                                <h3 class="text-lg font-semibold">${title}</h3>
                                <p class="mt-2">${description}</p>
                            `;
                            
                            insightsGrid.appendChild(insightCard);
                        }
                    }
                });
            }
            
            function generateProgressTrendInsights(data) {
                Object.keys(data).forEach(exercise => {
                    const entries = data[exercise];
                    if (entries.length < 3) return;
                    
                    // Sort by date
                    const sortedEntries = [...entries].sort((a, b) => new Date(a.date) - new Date(b.date));
                    
                    // Get first and last third of entries
                    const firstThird = sortedEntries.slice(0, Math.ceil(sortedEntries.length / 3));
                    const lastThird = sortedEntries.slice(-Math.ceil(sortedEntries.length / 3));
                    
                    const firstAvg = firstThird.reduce((sum, e) => sum + e.value, 0) / firstThird.length;
                    const lastAvg = lastThird.reduce((sum, e) => sum + e.value, 0) / lastThird.length;
                    
                    const percentChange = Math.round((lastAvg - firstAvg) / firstAvg * 100);
                    
                    if (Math.abs(percentChange) >= 5) {
                        const insightCard = document.createElement("div");
                        insightCard.className = "card bg-base-100 shadow-sm p-4 border-l-4";
                        
                        if (percentChange > 0) {
                            insightCard.classList.add("border-success");
                        } else {
                            insightCard.classList.add("border-error");
                        }
                        
                        const title = `${exercise.charAt(0).toUpperCase() + exercise.slice(1)} Progress Trend`;
                        let description = "";
                        
                        if (percentChange > 0) {
                            description = `<span class="text-success">â–² Improving! ${percentChange}% increase</span> in performance over this period`;
                        } else {
                            description = `<span class="text-error">â–¼ Decreasing ${Math.abs(percentChange)}%</span> in performance over this period`;
                        }
                        
                        insightCard.innerHTML = `
                            <h3 class="text-lg font-semibold">${title}</h3>
                            <p class="mt-2">${description}</p>
                        `;
                        
                        insightsGrid.appendChild(insightCard);
                    }
                });
            }

            logButton.addEventListener("click", () => {
                const value = parseInt(entryInput.value);
                const exercise = exerciseType.value;

                if (!isNaN(value) && value > 0) {
                    const entry = { date: new Date().toISOString(), value: value };
                    dataManager.saveEntry(exercise, entry);
                    entryInput.value = "";
                    updateCards();
                } else {
                    alert("Please enter a valid number greater than zero.");
                }
            });

            addExerciseButton.addEventListener("click", () => {
                const newExercise = newExerciseInput.value.trim().toLowerCase();
                if (newExercise && !document.querySelector(`#exerciseType option[value="${newExercise}"]`)) {
                    const option = document.createElement("option");
                    option.value = newExercise;
                    option.textContent = newExercise.charAt(0).toUpperCase() + newExercise.slice(1);
                    exerciseType.appendChild(option);
                    newExerciseInput.value = "";
                }
            });

            dateRange.addEventListener("change", () => {
                updateCards();
            });

            exportButton.addEventListener("click", () => {
                const data = dataManager.getEntries();
                const selectedRange = dateRange.value;
                
                // Create a filtered copy of the data
                const filteredData = {};
                Object.keys(data).forEach(exercise => {
                    const entries = data[exercise] || [];
                    const filteredEntries = filterEntriesByDateRange(entries, selectedRange);
                    if (filteredEntries.length > 0) {
                        filteredData[exercise] = filteredEntries;
                    }
                });
                
                const dataStr = JSON.stringify(filteredData, null, 2);
                const dataUri = "data:application/json;charset=utf-8," + encodeURIComponent(dataStr);
                
                const rangeSuffix = selectedRange === "all" ? "" : "-" + selectedRange;
                const exportFileName = "progress-data" + rangeSuffix + "-" + new Date().toISOString().split("T")[0] + ".json";
                
                const linkElement = document.createElement("a");
                linkElement.setAttribute("href", dataUri);
                linkElement.setAttribute("download", exportFileName);
                linkElement.click();
            });

            updateCards();
        });
    </script>
</body>
</html>
